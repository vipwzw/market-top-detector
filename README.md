# 比特币趋势反转策略 — 技术文档

## 一、项目概述

本项目构建了一套**多层次、多方法**的加密货币趋势反转识别与预测系统，目标是：

1. **识别市场的大周期顶底**（逃顶 / 抄底）
2. **区分大周期与小周期信号**（避免在下降通道中误操作）
3. **量化当前市场的风险/机会水平**（0–100 评分）
4. **通过 Transformer 深度学习模型预测未来走势**
5. **在样本外数据上验证策略有效性**

### 数据覆盖

| 类别 | 内容 |
|------|------|
| **价格数据** | 22 个加密货币日线（BTC、ETH、XRP、BNB、SOL 等），BTC 覆盖 2014–2026 |
| **情绪数据** | Fear & Greed Index（2018–2026）、Google Trends "Bitcoin"（2014–2026） |

---

## 二、系统架构

系统分为五个递进模块，从规则模型到深度学习逐步演进：

```
┌────────────────────────────────────────────────────────────────┐
│  Layer 1: 自适应多层转折点检测 (规则驱动)                         │
│  → 识别大顶/大底/小顶/小底，划分牛熊市                            │
├────────────────────────────────────────────────────────────────┤
│  Layer 2: 多因子复合风险评分模型 (统计驱动)                       │
│  → 逃顶指数 + 抄底指数，价格因子 60% + 情绪因子 40%               │
├────────────────────────────────────────────────────────────────┤
│  Layer 3: 单资产 Transformer 模型 (深度学习)                     │
│  → BTC 独立训练，滚动窗口预测未来 180 天走势                      │
├────────────────────────────────────────────────────────────────┤
│  Layer 4: 多资产 Transformer 模型 (深度学习 + 迁移学习)           │
│  → 22 币种联合训练，大幅增加样本量与牛熊周期覆盖                   │
├────────────────────────────────────────────────────────────────┤
│  Layer 5: 策略回测与对比 (实战验证)                               │
│  → CFX 纯样本外预测，Transformer 信号 vs EMA 策略                │
└────────────────────────────────────────────────────────────────┘
```

---

## 三、Layer 1 — 自适应多层转折点检测

> 脚本：`scripts/plot_two_layer_peaks.py`
> 输出：`img/btc_two_layer_full.png`、`img/btc_skeleton_full.png`

### 3.1 核心算法

基于 **Pagan-Sossounov (2003)** 算法改进，三项关键创新：

| 改进点 | 传统方法 | 本算法 |
|--------|---------|--------|
| 阈值 | 固定 20% | 根据波动率动态调整 |
| 级别 | 单一级别 | 区分大周期 / 小周期 |
| 验证 | 仅涨跌幅 | 趋势结构验证（HH/HL/LH/LL） |

### 3.2 动态阈值计算

$$
\sigma = \text{std}(r_{\text{daily}}) \times \sqrt{252}
$$

$$
\text{ratio} = \frac{\sigma}{\sigma_{\text{base}}} \quad (\sigma_{\text{base}} = 0.75)
$$

$$
\text{adj} = \text{clip}\left(\sqrt{\text{ratio}},\ 0.5,\ 2.0\right)
$$

$$
\text{major\_threshold} = 0.50 \times \text{adj}, \quad \text{minor\_threshold} = 0.20 \times \text{adj}
$$

不同资产的自适应结果：

| 资产 | 年化波动率 | 大周期阈值 | 小周期阈值 |
|------|-----------|-----------|-----------|
| BTC | 50–56% | 41–43% | 16–17% |
| ETH | 68% | 48% | 19% |
| SOL | 102% | 58% | 23% |

### 3.3 两层信号分类

| 信号类型 | 判定标准 | 操作建议 |
|----------|---------|---------|
| **大顶** | 后续下跌 ≥ major_threshold，且是上升段最高点（非 Lower High） | **卖出** |
| **大底** | 后续上涨 ≥ major_threshold，且是下降段最低点 | **买入** |
| 小顶 | 涨跌幅在 minor ~ major 之间，或在下降通道中的反弹高点 | 持有不动 |
| 小底 | 涨跌幅在 minor ~ major 之间，或在下降通道中的中间低点 | 持有不动 |

### 3.4 趋势结构验证（关键创新）

**问题**：2018 年 BTC 从 $19,497 跌至 $3,237 的下降通道中，中间多次反弹（$6,955→$11,573→$6,636→$9,858…）不应被标记为大周期信号。

**解决方案**：

1. **下降通道中的反弹高点（Lower High）** → 小顶，不是大顶
2. **下降通道中的中间低点** → 小底，只有最终底部（$3,237）才是大底
3. **上升通道中的回调低点（Higher Low）** → 小底，不是大底

### 3.5 BTC 历史大周期转折点

| 日期 | 类型 | 价格 | 说明 |
|------|------|------|------|
| 2015-01-14 | 大底 | $178 | 起始底部 |
| 2017-12-16 | **大顶** | **$19,497** | 第一次大牛市顶 |
| 2018-12-15 | **大底** | **$3,237** | 83% 回撤后的真正底部 |
| 2019-06-26 | 大顶 | $13,016 | 反弹顶 |
| 2020-03-12 | **大底** | **$4,971** | COVID 暴跌底 |
| 2021-11-08 | **大顶** | **$67,567** | 第二次大牛市顶 |
| 2022-11-21 | **大底** | **$15,787** | FTX 崩盘后底部 |

---

## 四、Layer 2 — 多因子复合风险评分模型

> 脚本：`scripts/top_risk_model.py`
> 输出：`img/top_risk_model_v2.png`（5 面板图表）

### 4.1 方法概述

提取历史 4 次大顶（2014、2017、2019、2021）的共性特征，构建多因子复合打分系统，每日输出两个指数：

- **逃顶指数**（Top Risk Index）：0–100，越高越危险
- **抄底指数**（Bottom Opportunity Index）：0–100，越高越值得买

### 4.2 特征工程

#### 价格因子（24 个特征）

| 类别 | 特征 | 说明 |
|------|------|------|
| 均线偏离 | `ma50_dev` ~ `ma700_dev` | 价格偏离 50/100/200/350/700 日均线的百分比 |
| Pi Cycle | `pi_cycle_ratio` | 111DMA / (350DMA×2)，历史上大顶时趋近 1.0 |
| ATH 相关 | `ath_drawdown`, `days_since_ath` | 距历史高点的回撤与天数 |
| 波动率 | `vol_30d`, `vol_90d`, `vol_365d` | 30/90/365 日年化波动率 |
| RSI | `rsi_14`, `rsi_30`, `rsi_90` | 多周期相对强弱指数 |
| 动量 | `ret_30d`, `ret_90d`, `ret_365d` | 多期收益率 |
| 估值 | `mayer`, `log_detrend_z` | Mayer 倍数（price/200DMA）、对数去趋势 Z-Score |
| 加速度 | `ma50_slope`, `ma50_accel` | 50 日均线斜率及其变化 |
| 累计涨幅 | `rally_from_bottom` | 从上一个大底至今的总涨幅 |

#### 情绪因子（8 个特征）

| 类别 | 特征 | 说明 |
|------|------|------|
| Fear & Greed | `fng_value`, `fng_ma30`, `fng_ma90` | 恐惧贪婪指数及其均值 |
| FNG 极值 | `fng_extreme_greed_pct`, `fng_above60_pct` | 近 90 天极度贪婪占比、近 30 天贪婪占比 |
| Google Trends | `gtrend`, `gtrend_z`, `gtrend_mom` | 搜索量、Z-Score、90 天动量 |

### 4.3 打分模型

#### 逃顶打分（17 个因子，价格 60% + 情绪 40%）

核心逻辑：当前值与历史大顶中位数的接近程度 → 映射到 0–100 分。

| 因子 | 权重 | 说明 |
|------|------|------|
| `ma200_dev` | 10 | 偏离 200DMA 越远越危险 |
| `mayer` | 10 | Mayer 倍数越高越危险 |
| `fng_value` | 8 | FNG 越高越危险 |
| `fng_ma30` | 8 | 30 天 FNG 均值越高越危险 |
| `rsi_30` / `rsi_90` | 7+7 | RSI 越高越危险 |
| `ret_90d` / `ret_365d` | 7+7 | 短/长期收益率越高越危险 |
| `gtrend` | 6 | 搜索量越高越过热 |
| `fng_extreme_greed_pct` | 6 | 极度贪婪频率越高越危险 |
| `pi_cycle_ratio` / `rally_from_bottom` / `log_detrend_z` / `ma50_slope` / `fng_above60_pct` / `gtrend_z` / `gtrend_mom` | 3–5 | 辅助因子 |

#### 抄底打分（14 个因子）

核心逻辑：当前值与历史大底中位数的接近程度 → 映射到 0–100 分。底部特征包括大幅回撤、低 RSI、低 Mayer、极度恐惧等。

### 4.4 综合评估逻辑

```
逃顶 > 70  → 极度危险，强烈建议清仓离场
逃顶 > 55  → 高位风险，建议逐步减仓
抄底 > 70  → 极度低估，强烈建议抄底建仓
抄底 > 55  → 底部区域，建议分批建仓
```

### 4.5 历史验证

模型在 4 次历史大顶和 4 次历史大底上的表现：

- **大顶时**逃顶指数均 > 55（高危以上）
- **大底时**抄底指数均 > 55（可抄底以上）
- 信号没有漏判

---

## 五、Layer 3 — 单资产 Transformer 逃顶/抄底模型

> 脚本：`scripts/transformer_risk_model.py`
> 输出：`img/transformer_risk_model.png`（4 面板图表）

### 5.1 核心思想

不再依赖手工定义的规则和历史顶底，而是让深度学习模型**直接从数据中学习**什么情况下未来会大跌（需要逃顶）或大涨（可以抄底）。

### 5.2 标签设计

每一天都是一个训练样本，标签来自**未来 180 天**的实际走势：

$$
\text{label\_top}_t = \text{clip}\left(-\min_{j \in [1, 180]} \frac{P_{t+j} - P_t}{P_t},\ 0,\ 1\right)
$$

$$
\text{label\_bot}_t = \text{clip}\left(\frac{\max_{j \in [1, 180]} \frac{P_{t+j} - P_t}{P_t}}{2},\ 0,\ 1\right)
$$

- **逃顶标签**：未来 180 天最大回撤的绝对值（0→安全，1→跌 100%）
- **抄底标签**：未来 180 天最大涨幅 / 2（0→无机会，1→涨 200%+）

### 5.3 模型架构

```
RiskTransformer:
  Input: (batch, 120, 23)  ← 120 天历史 × 23 个特征
  ├─ Linear(23 → 64)       ← 特征投影
  ├─ PositionalEncoding     ← 正弦位置编码
  ├─ TransformerEncoder ×3  ← 3 层 Encoder，4 头注意力，GELU 激活
  │    d_model=64, d_ff=256, dropout=0.1
  ├─ 取最后一个时间步 [:, -1, :]
  ├─ head_top: Linear→GELU→Dropout→Linear→Sigmoid  → 逃顶概率
  └─ head_bot: Linear→GELU→Dropout→Linear→Sigmoid  → 抄底概率
```

### 5.4 训练策略

- **滚动窗口**：训练 2 年 → 预测 1 年 → 滑动 1 年
- **优化器**：AdamW，lr=1e-3，weight_decay=1e-4
- **学习率调度**：CosineAnnealingLR
- **损失函数**：MSE（逃顶 + 抄底联合训练）
- **梯度裁剪**：max_norm=1.0
- **设备**：Apple MPS（M 系列芯片 GPU 加速）

### 5.5 特征列表（23 维 → Layer 4 扩展为 26 维）

#### 价格技术特征（17 维）

`ma20_dev`, `ma50_dev`, `ma100_dev`, `ma200_dev`, `mayer`, `rsi_14`, `rsi_30`, `vol_30d`, `vol_90d`, `ret_7d`, `ret_30d`, `ret_90d`, `ret_180d`, `ret_365d`, `ath_dd`, `days_since_ath`, `log_detrend`

#### 情绪特征（3 维）

`fng_norm`, `fng_ma30`, `gt_norm`

#### 成交量特征（6 维，Layer 4+ 新增）

| 特征 | 说明 | 顶部特征 | 底部特征 |
|------|------|---------|---------|
| `vratio_20` | 当日量 / 20 日均量 | 放量 (>2) | 缩量 (<0.5) |
| `vratio_50` | 当日量 / 50 日均量 | 放量 | 缩量 |
| `vma20_trend` | 20 日量均线变化率 | 量上升 | 量萎缩 |
| `vma50_trend` | 50 日量均线变化率 | 量趋势增 | 量趋势减 |
| `vprice_corr_30` | 30 天量价相关系数 | 正→负 (背离) | 低/负 |
| `obv_detrend` | OBV 去趋势标准化 | 高位回落 | 低位 |

### 5.6 评估指标

使用**预测值与实际未来走势的皮尔逊相关系数**衡量：

$$
r = \text{corr}(\hat{y}_{\text{pred}},\ y_{\text{actual}})
$$

---

## 六、Layer 4 — 多资产 Transformer 模型

> 脚本：`scripts/multi_asset_transformer.py`
> 输出：`img/multi_asset_transformer.png`（4 面板图表）

### 6.1 核心改进

单资产 BTC 训练样本有限（约 2,400 样本/窗口），导致模型泛化能力不足。多资产方案通过 **21 个加密货币联合训练**解决这一问题：

| 改进 | 单资产 | 多资产 (无成交量) | 多资产 (有成交量) |
|------|--------|-----------------|-----------------|
| 训练币种 | 仅 BTC | 21 个币种 | 21 个币种 |
| 特征维度 | 23 | 20 | **26** |
| 样本量/窗口 | ~2,400 | ~7,300 | ~7,300 |
| 最终训练集 | ~2,400 | ~44,900 | ~44,900 |
| BTC 逃顶相关性 r | -0.01 | 0.470 | — |
| BTC 抄底相关性 r | -0.02 | 0.398 | — |
| 训练 loss | — | 0.00898 | **0.00671** |

### 6.2 训练币种 (21 个)

BTC、ETH、XRP、BNB、SOL、TRX、DOGE、BCH、ADA、LEO、XMR、LINK、LTC、XLM、HBAR、ZEC、AVAX、CRO、UNI、DOT、TON

**排除**：稳定币（USDT/USDC/DAI/PAXG）、映射币（WBTC）、历史太短的币（MNT/HYPE/SUI）、数据异常（SHIB 有效样本为 0）

### 6.3 训练流程

1. 逐币种加载数据 → 特征工程 → 标签生成
2. 滚动窗口按时间切分（训练 2 年 → 预测 1 年）
3. 每个窗口：所有币种的训练样本**混合打乱**后联合训练
4. 评估：BTC 预测区间相关性 + 全币种平均相关性
5. 最终模型：用截止到 `max_date - 180 天` 的全量数据训练

### 6.4 模型超参数

| 参数 | 值 | 说明 |
|------|-----|------|
| SEQ_LEN | 120 | 约半年历史 |
| FWD_DAYS | 180 | 前瞻半年 |
| D_MODEL | 64 | 隐藏维度 |
| NHEAD | 4 | 注意力头数 |
| N_LAYERS | 3 | Encoder 层数 |
| DROPOUT | 0.15 | 正则化 |
| BATCH | 256 | 批大小 |
| EPOCHS | 40 | 训练轮数 |
| LR | 5e-4 | 学习率 |

### 6.5 滚动窗口评估结果 (BTC)

8 个滚动窗口的 BTC 逃顶/抄底预测相关性：

| 窗口 | 训练期 | 预测期 | 训练币数 | 训练样本 | BTC 逃顶 r | BTC 抄底 r | 全币平均 r_top | 全币平均 r_bot |
|------|--------|--------|---------|---------|-----------|-----------|-------------|-------------|
| W1 | 2015–2017 | 2017–2018 | 2 | 1,222 | **0.774** | **0.642** | 0.748 | 0.597 |
| W2 | 2016–2018 | 2018–2019 | 2 | 1,220 | **0.699** | 0.394 | -0.344 | -0.125 |
| W3 | 2017–2019 | 2019–2020 | 13 | 3,332 | 0.497 | 0.515 | 0.366 | 0.321 |
| W4 | 2018–2020 | 2020–2021 | 14 | 7,518 | **0.718** | **0.861** | 0.411 | 0.295 |
| W5 | 2019–2021 | 2021–2022 | 16 | 9,077 | -0.397 | -0.091 | 0.249 | 0.087 |
| W6 | 2020–2022 | 2022–2023 | 20 | 10,924 | 0.409 | -0.068 | 0.345 | 0.187 |
| W7 | 2021–2023 | 2023–2024 | 21 | 12,462 | **0.773** | 0.491 | 0.595 | 0.399 |
| W8 | 2022–2024 | 2024–2025 | 21 | 12,831 | 0.289 | 0.443 | 0.523 | 0.492 |
| **平均** | | | | | **0.470** | **0.398** | **0.362** | **0.282** |

**关键发现**：
- 6/8 个窗口 BTC 逃顶 r > 0.3，说明模型在大部分周期中具备预测能力
- W5（2021–2022）是唯一负相关窗口，对应 2021 年牛市顶部→2022 年熊市，这是历史上最难预测的转折
- 随着训练币种和样本增多（W1 的 2 币→W8 的 21 币），全币平均 r 显著提升

---

## 七、Layer 5 — 策略回测与对比

> 脚本：`scripts/cfx_predict_vs_ema.py`
> 输出：`img/cfx_predict_vs_ema.png`（7 面板图表）

### 7.1 实验设计

**目标**：验证多资产 Transformer 模型在**完全未见过**的币种上的预测能力。

- **训练集**：21 个币种（排除 CFX），含成交量特征（26 维）
- **测试集**：CFX（Conflux）— 模型从未见过，纯样本外
- **对比基线**：8 组 EMA 均线交叉策略 + Buy & Hold

### 7.2 Transformer 策略族

三类策略信号构建方式：

**A. 独立阈值策略**
```
买入: bot_signal > buy_threshold AND top_signal < sell_threshold
卖出: top_signal > sell_threshold
```

**B. 综合信号策略**
```
combined = bot_signal - top_signal
买入: combined > buy_threshold
卖出: combined < -sell_threshold
```

**C. 比率策略**
```
买入: bot_signal / top_signal > buy_ratio
卖出: top_signal / bot_signal > sell_ratio
```

### 7.3 参数扫描

- 平滑窗口：3、5、7、14 天
- 独立阈值：买入 0.20–0.50 × 卖出 0.15–0.40（168 组）
- 综合信号：买入 0.00–0.20 × 卖出 0.00–0.15（196 组）
- 比率策略：买入比 1.2–3.0 × 卖出比 1.2–2.5（80 组）
- 合计 **1,700+** 组参数扫描

### 7.4 EMA 基线策略

| 快线 | 慢线 | 说明 |
|------|------|------|
| 5 | 13 | 超短线 |
| 9 | 21 | 短线 |
| 12 | 26 | MACD 风格 |
| 15 | 45 | 中短线 |
| 20 | 50 | 中线 |
| 20 | 60 | 中线 |
| 30 | 90 | 中长线 |
| 50 | 200 | 经典长线 |

### 7.5 回测引擎

- 单边手续费 0.1%
- 计算指标：总收益、年化收益、最大回撤、Sharpe 比率、交易次数、胜率、平均持仓天数

### 7.6 策略分档选优

按交易频率分为四档，每档选 Sharpe 最优：

| 频率档 | 交易笔数范围 |
|--------|-------------|
| 低频 | 3–6 笔 |
| 中频 | 6–12 笔 |
| 高频 | 12–30 笔 |
| 超高频 | 30+ 笔 |

### 7.7 CFX 样本外预测能力

CFX 从未参与训练，模型仍然达到了：

| 指标 | 无成交量 | 有成交量 | 改善 |
|------|---------|---------|------|
| 逃顶相关性 r | 0.433 | **0.543** | +25% |
| 抄底相关性 r | 0.559 | **0.632** | +13% |

### 7.8 最终回测结果 (含成交量特征)

| 策略 | 总收益 | Sharpe | 最大回撤 | 交易 | 胜率 |
|------|--------|--------|---------|------|------|
| **TF-低频 s14 B>0.50 S>0.30** | **+1832%** | **1.22** | **-50.9%** | **4** | **100%** |
| **TF-中频 s14 B>0.40 S>0.25** | **+1624%** | **1.19** | **-50.9%** | **6** | **100%** |
| EMA(20,50) — 最优 EMA | +1092% | 1.00 | -73.0% | 8 | 50% |
| EMA(15,45) | +963% | 0.98 | -77.2% | 9 | 44% |
| TF-高频 s3 B>0.25 S>0.30 | +520% | 0.89 | -50.9% | 13 | 85% |
| EMA(12,26) | +496% | 0.85 | -77.7% | 25 | 24% |
| EMA(30,90) | +263% | 0.76 | -68.7% | 6 | 67% |
| EMA(9,21) | +259% | 0.75 | -77.9% | 29 | 28% |
| EMA(50,200) | +44% | 0.53 | -86.2% | 5 | 40% |
| Buy & Hold | +0% | 0.00 | — | 0 | — |

**Transformer vs EMA 核心优势**：

| 维度 | Transformer 最优 | EMA 最优 | 优劣 |
|------|-----------------|---------|------|
| Sharpe | **1.22** | 1.00 | TF 高 22% |
| 最大回撤 | **-50.9%** | -73.0% | TF 低 22 个百分点 |
| 胜率 | **100%** | 50% | TF 完胜 |
| 交易频率 | 4 笔 | 8 笔 | TF 更低频 |

### 7.9 中频策略逐笔交易 (6 笔, 100% 全胜)

| # | 买入日期 | 卖出日期 | 买入价 | 卖出价 | 收益 | 持仓天 |
|---|---------|---------|--------|--------|------|--------|
| 1 | 2022-07-12 | 2022-07-18 | $0.0437 | $0.0542 | +24.1% | 6 |
| 2 | 2022-10-11 | 2023-01-31 | $0.0382 | $0.0546 | +42.9% | 112 |
| 3 | 2023-02-13 | 2023-02-20 | $0.0518 | $0.3252 | **+527.3%** | 7 |
| 4 | 2023-08-22 | 2023-11-06 | $0.1264 | $0.1663 | +31.5% | 76 |
| 5 | 2024-08-15 | 2024-08-22 | $0.1321 | $0.1477 | +11.8% | 7 |
| 6 | 2025-04-06 | 2025-05-11 | $0.0710 | $0.0978 | +37.7% | 35 |

### 7.10 成交量特征的影响

加入 6 个成交量特征后的全面提升：

| 指标 | 无成交量 | 有成交量 | 改善 |
|------|---------|---------|------|
| 训练 loss | 0.00898 | **0.00671** | -25% |
| CFX 逃顶 r | 0.433 | **0.543** | +25% |
| CFX 抄底 r | 0.559 | **0.632** | +13% |
| 最优 Sharpe | 1.09 | **1.22** | +12% |
| 最优收益 | +1190% | **+1832%** | +54% |
| 最大回撤 | -65.5% | **-50.9%** | 改善 15pp |

成交量特征的价值在于：模型学会了通过量价关系更精准地识别逃顶时机，将最大回撤从 -65.5% 改善到 -50.9%。

---

## 八、核心算法引用

### 8.1 学术基础

| 算法/论文 | 年份 | 应用位置 |
|-----------|------|---------|
| **Pagan-Sossounov** "A Simple Framework for Bull and Bear Markets" | 2003 | Layer 1：候选转折点识别 |
| **Bry-Boschan** NBER 商业周期划分 | 1971 | Layer 1：审查规则参考 |
| **Lunde-Timmermann** "Duration Dependence in Stock Prices" | 2004 | Layer 1：持续时间分析 |
| **Triple Barrier Labeling** (Marcos López de Prado) | 2018 | Layer 3/4：标签设计参考 |
| **Transformer** "Attention Is All You Need" | 2017 | Layer 3/4：模型基础 |

### 8.2 技术指标

| 指标 | 公式/说明 |
|------|----------|
| **Mayer Multiple** | Price / 200DMA |
| **Pi Cycle Top** | 111DMA / (350DMA × 2)，历史上 ≈1.0 时触发大顶 |
| **RSI** | $100 - \frac{100}{1 + \frac{\text{avg gain}}{\text{avg loss}}}$ |
| **对数去趋势** | $\ln(P) - \text{linear\_fit}(\ln(P))$，再做 Z-Score |

---

## 九、文件结构

```
market-top-detector/
├── data/
│   ├── BTC_daily_full.csv          # BTC 完整日线 (2014-2026)
│   ├── {COIN}_daily.csv            # 21 个币种日线数据 (含 Volume)
│   ├── CFX_daily.csv               # CFX 日线数据 (样本外测试)
│   ├── cfx_predictions.csv         # CFX 预测缓存 (避免重复训练)
│   ├── fear_greed_index.csv        # 恐惧贪婪指数
│   └── google_trends_bitcoin.csv   # Google Trends 搜索量
│
├── scripts/
│   ├── plot_two_layer_peaks.py     # Layer 1: 两层转折点可视化
│   ├── top_risk_model.py           # Layer 2: 多因子风险评分模型
│   ├── transformer_risk_model.py   # Layer 3: 单资产 Transformer
│   ├── multi_asset_transformer.py  # Layer 4: 多资产 Transformer (BTC 评估)
│   └── cfx_predict_vs_ema.py       # Layer 5: CFX 回测对比 (含成交量特征)
│
├── models/
│   └── multi_asset_final.pt        # 最终模型权重 (含成交量特征)
│
├── img/                            # 生成的图表
│   ├── btc_two_layer_full.png      # 两层转折点标注
│   ├── btc_skeleton_full.png       # 骨架图
│   ├── top_risk_model_v2.png       # 逃顶+抄底双指数
│   ├── transformer_risk_model.png  # 单资产 Transformer
│   ├── multi_asset_transformer.png # 多资产 Transformer
│   └── cfx_predict_vs_ema.png      # CFX 策略对比 (7 面板)
│
└── README.md                       # 本文档
```

---

## 十、模型对比与总结

### 10.1 各层模型特点对比

| 维度 | Layer 1 规则 | Layer 2 统计 | Layer 3 单资产 DL | Layer 4 多资产 DL |
|------|-------------|-------------|-----------------|-----------------|
| **方法** | Pagan-Sossounov 改进 | 历史大顶/大底特征匹配 | Transformer 回归 | 多币种联合 Transformer |
| **输入** | 仅价格 | 价格 + 情绪 (32 特征) | 价格 + 情绪 (23 特征) | 价格 + 情绪 + 成交量 (26 特征) |
| **输出** | 大顶/大底/小顶/小底 | 逃顶指数 + 抄底指数 | 逃顶概率 + 抄底概率 | 同 Layer 3 |
| **训练样本** | 不需要训练 | 不需要训练 | ~2,400/窗口 | ~7,300/窗口 (最终 44,900) |
| **BTC 逃顶 r** | — | — | -0.01 | **0.470** |
| **CFX 样本外 r** | — | — | — | **逃顶 0.543, 抄底 0.632** |
| **可解释性** | 高 | 高 | 低 | 低 |
| **泛化性** | 需调阈值 | 依赖历史特征 | 受限 | **跨币种泛化** |
| **实时性** | 事后确认 | 实时评分 | 实时预测 | 实时预测 |

### 10.2 策略应用建议

| 场景 | 推荐方法 | 原因 |
|------|---------|------|
| **判断当前是否在大顶/大底附近** | Layer 2 多因子评分 | 可解释性强，历史验证充分 |
| **预测未来 6 个月走势方向** | Layer 4 多资产 Transformer | 泛化能力最强 |
| **构建交易策略** | Layer 5 回测框架 | 完整的信号→策略→回测流水线 |
| **理解市场周期结构** | Layer 1 多层转折点 | 直观展示大/小周期关系 |
| **迁移到其他币种** | Layer 1（自适应阈值）+ Layer 4（多币种训练） | 均具备跨资产能力 |

### 10.3 关键结论

1. **多资产泛化是核心突破**：从 BTC 单币种 r ≈ 0 到 21 币种联合训练 r ≈ 0.47，样本量的质变带来了质的飞跃
2. **成交量特征贡献显著**：加入 6 个量价特征后，CFX 相关性提升 13–25%，最大回撤改善 15 个百分点
3. **Transformer 在低/中频交易上全面优于 EMA**：Sharpe 更高、回撤更小、胜率更高，且交易频率更低
4. **高频交易中 EMA 略优**：交易频率超过 12 笔后，Transformer 信号噪声增大，EMA 的趋势跟踪更稳定
5. **模型具备真正的跨币种泛化能力**：CFX 从未参与训练，但样本外逃顶 r=0.543、抄底 r=0.632

### 10.4 模型局限性

1. **前瞻偏差**：Layer 1 的大/小周期判定需要未来数据确认，无法用于实时决策
2. **过拟合风险**：Transformer 模型在加密货币这种非平稳序列上容易过拟合
3. **标签噪音**：基于未来 180 天最大回撤/涨幅的标签可能引入噪音
4. **市场结构变化**：历史规律不保证未来有效，尤其是加密货币市场快速演化
5. **幸存者偏差**：训练币种均为市值 Top 排名币种，已预筛选过质量
6. **参数优化过拟合**：416 组参数扫描后选最优，存在对历史回测的过度拟合风险

### 10.5 后续改进方向

1. **Walk-forward 验证**：改用更严格的逐月滚动验证替代一次性参数优化
2. **加入链上数据**：活跃地址数、交易所净流入、MVRV 等链上指标
3. **多任务学习**：同时预测不同前瞻期（30/90/180/365 天）
4. **集成学习**：将 Layer 2 规则模型与 Layer 4 Transformer 组合
5. **实盘验证**：部署模型进行纸面交易，积累真实样本外数据

---

## 十一、开发历程参考

本项目的开发过程记录在以下对话中：

- [Transformer 趋势反转模型](255c3941-9c55-4685-bb23-593235dca4bd) — 从业界调研、反转标签设计、PatchTST 模型实现，到牛熊市识别算法的完整迭代过程
